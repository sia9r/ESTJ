<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>قیمت پارسیان، شمش، طلا</title>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1:#fff7e6; --bg2:#f9e6b3;
      --gold:#b8860b; --gold-strong:#d4af37;
      --card-bg: rgba(255,255,255,0.98);
      --muted:#6b4f00; --accent:#f9d976; --text:#222;
      --container-max:1100px;
    }
    html,body{height:100%;margin:0;padding:0;font-family:"Vazirmatn",Tahoma,sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:var(--text);-webkit-font-smoothing:antialiased}
    .wrap{max-width:var(--container-max);margin:18px auto;padding:18px;box-sizing:border-box}
    header.top{display:flex;gap:12px;align-items:flex-start;justify-content:space-between;margin-bottom:14px;position:sticky;top:0;z-index:90;padding:12px;border-radius:10px;background:linear-gradient(135deg,var(--bg1),var(--bg2));backdrop-filter:blur(6px)}
    .brand{display:flex;flex-direction:column;align-items:flex-start;gap:6px}
    h1{margin:0;font-size:20px;color:var(--gold);font-weight:900}
    .subtitle{font-size:12px;color:#666;font-weight:800}
    .top-controls{display:flex;flex-direction:column;gap:10px;align-items:flex-end;min-width:220px}
    .price-input{background:var(--card-bg);border-radius:12px;padding:10px 12px;display:flex;flex-direction:column;gap:8px;align-items:stretch;border:2px solid rgba(212,175,55,0.14);min-width:220px}
    .price-input label{font-weight:800;color:var(--muted);font-size:13px;text-align:right}
    .visual-small { width: 12ch; max-width:100%; box-sizing:border-box; text-align:center; direction:ltr; font-weight:900; font-size:15px; padding:6px 8px; border-radius:8px; border:1px solid #ddd; background:#fff; }
    .input-row { display:flex; gap:8px; align-items:center; justify-content:flex-end; }
    .clear-btn { background:#efefef; border:1px solid #ddd; padding:4px 8px; border-radius:6px; cursor:pointer; font-weight:900; }
    .switch-row{display:flex;gap:10px;align-items:center;justify-content:flex-end}
    .switch-item{display:flex;gap:8px;align-items:center;background:var(--card-bg);padding:8px 10px;border-radius:10px;border:1px solid rgba(0,0,0,0.04)}
    .switch-label{font-weight:800;font-size:13px;color:var(--muted);min-width:90px;text-align:right}
    .tiny-toggle{width:44px;height:24px;border-radius:999px;background:#c0392b;position:relative;cursor:pointer;flex:0 0 auto}
    .tiny-toggle::before{content:"";position:absolute;left:2px;top:2px;width:20px;height:20px;background:#fff;border-radius:50%;transition:transform .25s}
    .tiny-toggle.active{background:#27ae60}
    .tiny-toggle.active::before{transform:translateX(20px)}
    .tabs{display:flex;gap:10px;margin:12px 0 16px;flex-wrap:wrap}
    .tab{padding:10px 14px;border-radius:12px;background:transparent;border:2px solid transparent;font-weight:900;cursor:pointer;color:var(--muted);user-select:none}
    .tab.active{background:linear-gradient(90deg,var(--accent),#f39c12);color:#fff;box-shadow:0 10px 30px rgba(240,190,60,0.12)}
    .panel{background:var(--card-bg);border-radius:18px;padding:18px;box-shadow:0 18px 48px rgba(0,0,0,0.14);overflow:hidden}
    .panel-grid{display:grid;grid-template-columns:1fr 340px;gap:18px;align-items:start}
    @media(max-width:980px){.panel-grid{grid-template-columns:1fr}}
    .content{padding:6px}
    .controls{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px;align-items:center}
    .field{background:#fffbe6;border:2px solid var(--gold-strong);padding:10px;border-radius:12px;min-width:160px;flex:1}
    .field label{display:block;font-weight:800;color:var(--muted);font-size:14px;margin-bottom:8px;text-align:right}
    .field input,.field select{width:100%;padding:10px;border-radius:10px;border:1px solid #e6d6a0;font-weight:900;font-size:16px;text-align:center;background:transparent}
    .main-btn{background:linear-gradient(90deg,var(--accent),#f39c12);border:none;color:#fff;padding:12px 16px;border-radius:12px;font-weight:900;font-size:16px;cursor:pointer}
    .side{padding:12px;border-radius:12px;background:linear-gradient(180deg,#fff,#fff9e6);border:2px solid rgba(212,175,55,0.06)}
    .summary .big{font-size:22px;font-weight:900;color:var(--gold);text-align:right}
    .table{margin-top:12px;border-radius:12px;overflow:hidden;border:1px solid rgba(0,0,0,0.05)}
    table{width:100%;border-collapse:collapse;font-weight:800}
    thead th{background:#fff8e6;color:var(--muted);padding:10px 12px;text-align:right;font-size:14px}
    tbody td{padding:10px 12px;border-top:1px solid rgba(0,0,0,0.04);text-align:right;font-size:15px}
    tbody tr:hover{background:linear-gradient(90deg, rgba(255,250,220,0.6), rgba(255,250,220,0.4))}
    .price-cell{color:var(--gold);font-weight:900;font-size:15px;min-width:160px;text-align:right}
    .result-card{margin-top:8px;padding:14px;border-radius:12px;background:#fff8e6;border:1px solid rgba(212,175,55,0.06)}
    .big-number{font-size:28px;font-weight:900;color:var(--gold);text-align:center}
    .timestamp{font-size:13px;color:#666;margin-left:8px}
    footer{margin-top:18px;text-align:center;color:#666;font-weight:800;font-size:13px}
    @media(max-width:640px){
      .wrap{padding:12px}
      .top{padding:8px}
      .top-controls{min-width:0;align-items:stretch}
      .price-input{min-width:0}
      .tab{padding:8px 10px}
      .panel-grid{grid-template-columns:1fr}
      .side{order:2}
      .field{min-width:unset;width:100%}
      .main-btn{width:100%}
      .switch-item{justify-content:space-between;padding:10px}
      .input-row{justify-content:flex-start}
    }
    .dark{--bg1:#0f0f12;--bg2:#121217;--card-bg: rgba(6,6,6,0.6);--gold:#ffd973;--gold-strong:#f0c27b;--text:#eee;--muted:#f0c27b;background:linear-gradient(135deg,var(--bg1),var(--bg2))}
    /* small spacing for price + button */
    .price-display-row { display:flex; gap:8px; align-items:center; justify-content:center; margin-top:10px; }
    .fetch-btn { padding:6px 10px; border-radius:8px; border:1px solid #ddd; background:#fff; cursor:pointer; font-weight:800; }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="top" role="banner" aria-label="هدر">
      <div class="brand" aria-hidden="false">
        <div><h1>داشبورد </h1></div>
        <div class="subtitle">نسخه رسمی</div>
      </div>

      <div class="top-controls" role="region" aria-label="کنترل‌های بالا">
        <div class="price-input" title="قیمت ۱۸ و ۲۴ را وارد کنید (هر کدام را وارد کنید دیگری خودکار می‌شود)">
          <div class="input-row">
            <label for="price18">قیمت ۱۸ عیار</label>
            <div style="display:flex;gap:6px;align-items:center">
              <input id="price18" class="visual-small" inputmode="numeric" placeholder="مثلاً 10,000,000" aria-label="قیمت ۱۸ عیار" />
              <button type="button" class="clear-btn" data-target="price18" title="پاک کردن">×</button>
            </div>
          </div>
          <div class="input-row">
            <label for="price24">قیمت ۲۴ عیار</label>
            <div style="display:flex;gap:6px;align-items:center">
              <input id="price24" class="visual-small" inputmode="numeric" placeholder="مثلاً 13,333,333" aria-label="قیمت ۲۴ عیار" />
              <button type="button" class="clear-btn" data-target="price24" title="پاک کردن">×</button>
            </div>
          </div>
        </div>

        <div class="switch-row" aria-hidden="false">
          <div class="switch-item" role="group" aria-label="تم">
            <div class="switch-label">حالت تاریک</div>
            <div id="themeToggle" class="tiny-toggle" role="switch" aria-checked="false" tabindex="1" aria-label="تغییر حالت تاریک"></div>
          </div>
          <div class="switch-item" role="group" aria-label="نمایش زمان">
            <div class="switch-label">نمایش تاریخ و زمان</div>
            <div id="timeToggleTop" class="tiny-toggle" role="switch" aria-checked="false" tabindex="1" aria-label="نمایش تاریخ و زمان"></div>
          </div>
        </div>

        <div style="display:flex;justify-content:flex-end">
          <div id="headerTimestamp" class="timestamp" style="display:none">—</div>
        </div>
      </div>
    </header>

    <div class="tabs" role="tablist" aria-label="مودها">
      <div class="tab active" data-mode="parsian" role="tab" aria-selected="true">پارسیان</div>
      <div class="tab" data-mode="shamsh" role="tab" aria-selected="false">شمش</div>
      <div class="tab" data-mode="fabric" role="tab" aria-selected="false">محاسبه طلا</div>
    </div>

    <section class="panel" role="main">
      <div class="panel-grid">
        <div class="content">
          <div style="margin-bottom:14px; text-align:center;">
            <h2 style="margin:0 0 6px 0">قیمت یک گرم 18 طلا در این لحظه</h2>

            <style>#gram18_price_now { font-size:31px; color:#3ec854; font-weight:bold; text-align:center; }</style>

            <div class="price-display-row">
              <div id="gram18_price_now">در حال دریافت...</div>
              <button id="fetchPriceBtn" class="fetch-btn" title="دریافت قیمت از سایت">دریافت قیمت</button>
            </div>
          </div>

          <!-- PARSIAN -->
          <div class="mode" id="parsian" data-mode="parsian">
            <div class="controls">
              <div class="field">
                <label>عیار محاسبه (پیش‌فرض ۱۸)</label>
                <select id="parsianPurity">
                  <option value="18" selected>۱۸</option><option value="19">۱۹</option><option value="20">۲۰</option>
                  <option value="21">۲۱</option><option value="22">۲۲</option><option value="23">۲۳</option>
                  <option value="24">۲۴</option><option value="custom">دلخواه</option>
                </select>
                <input id="parsianPurityCustom" placeholder="عیار دلخواه" style="display:none;margin-top:8px" />
              </div>

              <div class="field" style="min-width:150px">
                <div style="display:flex;align-items:center;justify-content:center;">
                  <div id="parsianTolToggle" class="tiny-toggle" role="switch" aria-checked="false" title="تلورانس پنهان" tabindex="0"></div>
                  <select id="parsianTol" style="display:none;padding:8px;background:#fffbe6;border-radius:8px;border:1px solid var(--gold-strong);font-weight:800;margin-right:8px">
                    <option value="20000">۲۰٬۰۰۰</option><option value="50000">۵۰٬۰۰۰</option>
                    <option value="70000">۷۰٬۰۰۰</option><option value="100000">۱۰۰٬۰۰۰</option>
                  </select>
                </div>
              </div>

              <div class="field" style="min-width:180px">
                <label>فیلتر وزن دلخواه (گرم)</label>
                <div style="display:flex;gap:8px;align-items:center;justify-content:center">
                  <input id="parsianCustomWeight" placeholder="مثلاً 1.2" class="visual-small" />
                  <button class="clear-btn" data-target="parsianCustomWeight" title="پاک کردن">×</button>
                </div>
              </div>

              <div style="flex:0 0 140px;display:flex;align-items:center;">
                <button class="main-btn" id="parsianCalc">محاسبه</button>
              </div>
            </div>

            <div class="table" id="parsianTableWrap" aria-live="polite"></div>
          </div>

          <!-- SHAMSH -->
          <div class="mode" id="shamsh" data-mode="shamsh" style="display:none">
            <div class="controls">
              <div class="field">
                <label>عیار محاسبه (پیش‌فرض ۲۴)</label>
                <select id="shamshPurity">
                  <option value="18">۱۸</option><option value="19">۱۹</option><option value="20">۲۰</option>
                  <option value="21">۲۱</option><option value="22">۲۲</option><option value="23">۲۳</option>
                  <option value="24" selected>۲۴</option><option value="custom">دلخواه</option>
                </select>
                <input id="shamshPurityCustom" placeholder="عیار دلخواه" style="display:none;margin-top:8px" />
              </div>

              <div class="field" style="min-width:150px">
                <div style="display:flex;align-items:center;justify-content:center;">
                  <div id="shamshTolToggle" class="tiny-toggle" role="switch" aria-checked="false" title="تلورانس پنهان" tabindex="0"></div>
                  <select id="shamshTol" style="display:none;padding:8px;background:#fffbe6;border-radius:8px;border:1px solid var(--gold-strong);font-weight:800;margin-right:8px">
                    <option value="20000">۲۰٬۰۰۰</option><option value="50000">۵۰٬۰۰۰</option>
                    <option value="70000">۷۰٬۰۰۰</option><option value="100000">۱۰۰٬۰۰۰</option>
                  </select>
                </div>
              </div>

              <div class="field" style="min-width:180px">
                <label>فیلتر وزن دلخواه (گرم)</label>
                <div style="display:flex;gap:8px;align-items:center;justify-content:center">
                  <input id="shamshCustomWeight" placeholder="مثلاً 1.0" class="visual-small" />
                  <button class="clear-btn" data-target="shamshCustomWeight" title="پاک کردن">×</button>
                </div>
              </div>

              <div style="flex:0 0 140px;display:flex;align-items:center;">
                <button class="main-btn" id="shamshCalc">محاسبه</button>
              </div>
            </div>

            <div class="table" id="shamshTableWrap" aria-live="polite"></div>
          </div>

          <!-- FABRICATION -->
          <div class="mode" id="fabric" data-mode="fabric" style="display:none">
            <div class="controls">
              <div class="field">
                <label>وزن (گرم)</label>
                <div style="display:flex;gap:8px;align-items:center;justify-content:center">
                  <input id="fabWeight" placeholder="مثلاً 2.5" class="visual-small">
                  <button class="clear-btn" data-target="fabWeight" title="پاک کردن">×</button>
                </div>
              </div>

              <div class="field">
                <label>عیار قیمت (استفاده از قیمت‌های بالا)</label>
                <select id="fabPurity">
                  <option value="18" selected>۱۸</option><option value="19">۱۹</option><option value="20">۲۰</option>
                  <option value="21">۲۱</option><option value="22">۲۲</option><option value="23">۲۳</option>
                  <option value="24">۲۴</option><option value="custom">دلخواه</option>
                </select>
                <input id="fabPurityCustom" placeholder="عیار دلخواه" style="display:none;margin-top:8px" />
              </div>

              <div class="field">
                <label>درصد اجرت</label>
                <div style="display:flex;gap:8px;align-items:center;justify-content:center">
                  <input id="fabWage" placeholder="مثلاً 10" value="10" class="visual-small">
                  <button class="clear-btn" data-target="fabWage" title="پاک کردن">×</button>
                </div>
              </div>

              <div class="field">
                <label>درصد سود</label>
                <div style="display:flex;gap:8px;align-items:center;justify-content:center">
                  <input id="fabProfit" placeholder="مثلاً 7" value="7" class="visual-small">
                  <button class="clear-btn" data-target="fabProfit" title="پاک کردن">×</button>
                </div>
              </div>

              <div style="flex:0 0 140px;display:flex;align-items:center;">
                <button class="main-btn" id="fabCalc">محاسبه</button>
              </div>
            </div>

            <div class="result-card" aria-live="polite">
              <div class="big-number" id="fabFinal">—</div>
              <div style="display:flex;gap:8px;margin-top:10px;justify-content:space-around;flex-wrap:wrap">
                <div class="meta">قیمت خالص: <span id="fabPure">—</span></div>
                <div class="meta">اجرت: <span id="fabWageOut">—</span></div>
                <div class="meta">سود: <span id="fabProfitOut">—</span></div>
              </div>
              <div style="display:flex;gap:8px;margin-top:8px;justify-content:space-around;flex-wrap:wrap">
                <div class="meta">مالیات: <span id="fabTax">—</span></div>
                /* <div class="meta">تلورانس: <span id="fabTol">—</span></div> */
              </div>
            </div>
          </div>

        </div>

        <aside class="side" aria-label="خلاصه">
          <div class="summary">
            <div class="big">قیمت فعال: <span id="activePriceDisplay">—</span></div>
            <div class="meta">عیار فعال و تبدیل خودکار</div>
            <div class="meta" style="font-size:13px;color:#666">نکته: برای محاسبه از قیمت‌های بالای صفحه استفاده می‌شود.</div>
            <div style="height:1px"></div>
            <div style="margin-top:8px;display:flex;align-items:center;gap:8px;justify-content:flex-start">
              <div class="meta">آخرین محاسبه:</div>
              <div id="asideTimestamp" class="timestamp">—</div>
            </div>
          </div>
        </aside>

      </div>
      <footer>--------------------------------------------------</footer>
    </section>
  </div>

  <script>
    /* ---------- helpers ---------- */
    function fmt(n){ try{ return Number(n).toLocaleString('en-US'); }catch(e){return n} }
    function unfmt(str){ if(str===undefined||str===null) return NaN; let s = String(str).replace(/,/g,'').trim(); if(s==='') return NaN; return Number(s); }

    const price18Input = document.getElementById('price18');
    const price24Input = document.getElementById('price24');
    const gramDisplay = document.getElementById('gram18_price_now');
    const fetchBtn = document.getElementById('fetchPriceBtn');

    /* sync 18 <-> 24 */
    function syncFrom18(){
      const v = unfmt(price18Input.value);
      if(isNaN(v)){ price24Input.value=''; updateActivePriceDisplay(); return; }
      const p24 = v*(24/18);
      price24Input.value = fmt(Math.round(p24));
      updateActivePriceDisplay();
    }
    function syncFrom24(){
      const v = unfmt(price24Input.value);
      if(isNaN(v)){ price18Input.value=''; updateActivePriceDisplay(); return; }
      const p18 = v*(18/24);
      price18Input.value = fmt(Math.round(p18));
      updateActivePriceDisplay();
    }

    /* when user edits price18 manually, reflect to gram display */
    price18Input.addEventListener('input', (e)=>{
      const raw = e.target.value.replace(/,/g,'');
      price18Input.value = raw === '' ? '' : fmt(Number(raw));
      // reflect user's manual value to displayed "قیمت یک گرم 18 طلا در این لحظه"
      const p = unfmt(price18Input.value);
      if(!isNaN(p) && gramDisplay){
        gramDisplay.textContent = fmt(Math.round(p)) + ' تومان';
      }
      syncFrom18();
      autoCalcActive();
    });

    price24Input.addEventListener('input', (e)=>{
      const raw = e.target.value.replace(/,/g,'');
      price24Input.value = raw === '' ? '' : fmt(Number(raw));
      syncFrom24();
      autoCalcActive();
    });

    /* tabs */
    const tabs = document.querySelectorAll('.tab');
    const modes = document.querySelectorAll('.mode');
    tabs.forEach(t=> t.addEventListener('click', ()=>{
      tabs.forEach(x=>{ x.classList.remove('active'); x.setAttribute('aria-selected','false'); });
      t.classList.add('active'); t.setAttribute('aria-selected','true');
      const m = t.dataset.mode;
      modes.forEach(md=> md.style.display = (md.dataset.mode === m ? '' : 'none'));
      updateActivePriceDisplay();
      const contentTop = document.querySelector('.panel').offsetTop;
      window.scrollTo({top: contentTop - 10, behavior:'smooth'});
      autoCalcActive();
    }));

    /* weights, parsian/shamsh/fabric code (unchanged except shamsh ojrat values kept as you set) */
    const weights = [0.05,0.07,0.100,0.150,0.200,0.250,0.300,0.350,0.400,0.450,0.500,0.550,0.600,0.650,0.700,0.750,0.800,0.850,0.900,0.950,1.0,1.100,1.150,1.200,1.250,1.300,1.350,1.400,1.450,1.500,1.550,1.600,1.650,1.700,1.750,1.800,1.850,1.900,1.950,2.00,3.00,4.00];

    const parsianCalcBtn = document.getElementById('parsianCalc');
    const parsianTolToggle = document.getElementById('parsianTolToggle');
    const parsianTolSelect = document.getElementById('parsianTol');
    const parsianTableWrap = document.getElementById('parsianTableWrap');
    const parsianPurity = document.getElementById('parsianPurity');
    const parsianPurityCustom = document.getElementById('parsianPurityCustom');
    const parsianCustomWeight = document.getElementById('parsianCustomWeight');
    let parsianTol = 0;

    parsianTolToggle.addEventListener('click', ()=>{
      parsianTolToggle.classList.toggle('active');
      const active = parsianTolToggle.classList.contains('active');
      parsianTolSelect.style.display = active ? '' : 'none';
      parsianTol = active ? (parseInt(parsianTolSelect.value,10) || 0) : 0;
      autoCalcActive();
    });
    parsianTolSelect.addEventListener('change', ()=> { if(parsianTolToggle.classList.contains('active')) parsianTol = parseInt(parsianTolSelect.value,10) || 0; autoCalcActive(); });
    parsianPurity.addEventListener('change', ()=>{ parsianPurityCustom.style.display = parsianPurity.value==='custom' ? 'block' : 'none'; autoCalcActive(); });
    parsianPurityCustom.addEventListener('input', ()=> autoCalcActive());
    parsianCustomWeight.addEventListener('input', ()=> autoCalcActive());

    function parsianGetPricePerGram(){
      let p18 = unfmt(price18Input.value);
      if(isNaN(p18)){
        const p24 = unfmt(price24Input.value);
        if(isNaN(p24)) return NaN;
        p18 = p24 * (18/24);
        price18Input.value = fmt(Math.round(p18));
      }
      const purity = (parsianPurity.value==='custom'? Number(parsianPurityCustom.value) : Number(parsianPurity.value)) || 18;
      return (p18 * (purity/18));
    }
    function renderParsianTable(filteredWeight){
      const pricePerGram = parsianGetPricePerGram();
      if(isNaN(pricePerGram)){
        parsianTableWrap.innerHTML = '<div style="padding:12px;color:#b00;font-weight:900">لطفاً قیمت ۱۸ یا ۲۴ را در بالا وارد کنید.</div>';
        return;
      }
      let html = '<table aria-label="جدول پارسیان"><thead><tr><th>وزن (گرم)</th><th>قیمت نهایی</th></tr></thead><tbody>';
      const list = filteredWeight ? [Number(filteredWeight)] : weights;
      list.forEach(w=>{
        const goldCost = +(w * pricePerGram);
        const wage1 = 50000; const tax = +((goldCost + wage1) * 0.1);
        const wage2 = 100000;
        const total = Math.round(goldCost + wage1 + tax + wage2 + (parsianTol||0));
        html += `<tr><td>${w.toFixed(3)}</td><td class="price-cell">${fmt(total)} تومان</td></tr>`;
      });
      html += '</tbody></table>';
      parsianTableWrap.innerHTML = html;
    }

    /* SHAMSH */
    const shamshCalcBtn = document.getElementById('shamshCalc');
    const shamshTolToggle = document.getElementById('shamshTolToggle');
    const shamshTolSelect = document.getElementById('shamshTol');
    const shamshTableWrap = document.getElementById('shamshTableWrap');
    const shamshPurity = document.getElementById('shamshPurity');
    const shamshPurityCustom = document.getElementById('shamshPurityCustom');
    const shamshCustomWeight = document.getElementById('shamshCustomWeight');
    let shamshTol = 0;

    shamshTolToggle.addEventListener('click', ()=>{
      shamshTolToggle.classList.toggle('active');
      const active = shamshTolToggle.classList.contains('active');
      shamshTolSelect.style.display = active ? '' : 'none';
      shamshTol = active ? (parseInt(shamshTolSelect.value,10) || 0) : 0;
      autoCalcActive();
    });
    shamshTolSelect.addEventListener('change', ()=> { if(shamshTolToggle.classList.contains('active')) shamshTol = parseInt(shamshTolSelect.value,10) || 0; autoCalcActive(); });
    shamshPurity.addEventListener('change', ()=>{ shamshPurityCustom.style.display = shamshPurity.value==='custom' ? 'block' : 'none'; autoCalcActive(); });
    shamshPurityCustom.addEventListener('input', ()=> autoCalcActive());
    shamshCustomWeight.addEventListener('input', ()=> autoCalcActive());

    function shamshGetPricePerGram(){
      let p24 = unfmt(price24Input.value);
      if(isNaN(p24)){
        const p18 = unfmt(price18Input.value);
        if(isNaN(p18)) return NaN;
        p24 = p18 * (24/18);
        price24Input.value = fmt(Math.round(p24));
      }
      const purity = (shamshPurity.value==='custom'? Number(shamshPurityCustom.value) : Number(shamshPurity.value)) || 24;
      return (p24 * (purity/24));
    }
    function renderShamshTable(filteredWeight){
      const pricePerGram = shamshGetPricePerGram();
      if(isNaN(pricePerGram)){
        shamshTableWrap.innerHTML = '<div style="padding:12px;color:#b00;font-weight:900">لطفاً قیمت ۱۸ یا ۲۴ را در بالا وارد کنید.</div>';
        return;
      }
      let html = '<table aria-label="جدول شمش"><thead><tr><th>وزن (گرم)</th><th>قیمت نهایی</th></tr></thead><tbody>';
      const list = filteredWeight ? [Number(filteredWeight)] : weights;
      list.forEach(w=>{
        const goldCost = +(w * pricePerGram);
        const ojrat = (w >= 1.0) ? 630000 : 650000; 
        const base = goldCost + ojrat; const tax = +(base * 0.1);
        const total = Math.round(base + tax + (shamshTol||0));
        html += `<tr><td>${w.toFixed(3)}</td><td class="price-cell">${fmt(total)} تومان</td></tr>`;
      });
      html += '</tbody></table>';
      shamshTableWrap.innerHTML = html;
    }

    /* FABRICATION */
    const fabCalcBtn = document.getElementById('fabCalc');
    const fabWeightInput = document.getElementById('fabWeight');
    const fabWageInput = document.getElementById('fabWage');
    const fabProfitInput = document.getElementById('fabProfit');
    const fabFinal = document.getElementById('fabFinal');
    const fabPure = document.getElementById('fabPure');
    const fabWageOut = document.getElementById('fabWageOut');
    const fabProfitOut = document.getElementById('fabProfitOut');
    const fabTaxOut = document.getElementById('fabTax');
    const fabTolOut = document.getElementById('fabTol');
    const fabPurity = document.getElementById('fabPurity');
    const fabPurityCustom = document.getElementById('fabPurityCustom');

    fabPurity.addEventListener('change', ()=> { fabPurityCustom.style.display = fabPurity.value==='custom' ? 'block' : 'none'; autoCalcActive(); });
    fabWeightInput.addEventListener('input', ()=> autoCalcActive());
    fabWageInput.addEventListener('input', ()=> autoCalcActive());
    fabProfitInput.addEventListener('input', ()=> autoCalcActive());

    function getPriceForPurity(purity){
      const p18 = unfmt(price18Input.value);
      const p24 = unfmt(price24Input.value);
      if(!isNaN(p18)) return p18*(purity/18);
      if(!isNaN(p24)) return p24*(purity/24);
      return NaN;
    }
    function fabricateCalculate(){
      const weight = parseFloat(fabWeightInput.value);
      const purity = (fabPurity.value==='custom'? Number(fabPurityCustom.value) : Number(fabPurity.value)) || 18;
      const pricePerGram = getPriceForPurity(purity);
      const wagePercent = parseFloat(fabWageInput.value);
      const profitPercent = parseFloat(fabProfitInput.value);
      if(isNaN(weight) || isNaN(pricePerGram) || isNaN(wagePercent) || isNaN(profitPercent)){
        fabFinal.textContent = '⚠️ لطفاً مقادیر معتبر وارد کنید.';
        return;
      }
      const pure = +(weight * pricePerGram);
      const wage = +(pure * (wagePercent/100));
      const profit = +((pure + wage) * (profitPercent/100));
      const tax = +(0.1 * (wage + profit));
      const tol = 0;
      const total = Math.round(pure + wage + profit + tax + tol);
      fabFinal.textContent = fmt(total) + ' تومان';
      fabPure.textContent = fmt(Math.round(pure)) + ' تومان';
      fabWageOut.textContent = fmt(Math.round(wage)) + ' تومان';
      fabProfitOut.textContent = fmt(Math.round(profit)) + ' تومان';
      fabTaxOut.textContent = fmt(Math.round(tax)) + ' تومان';
      fabTolOut.textContent = fmt(tol) + ' تومان';
      updateTimestamp();
    }

    /* timestamp & theme */
    const timeToggleTop = document.getElementById('timeToggleTop');
    const headerTimestamp = document.getElementById('headerTimestamp');
    const asideTimestamp = document.getElementById('asideTimestamp');
    let topTimeVisible = false;
    timeToggleTop.addEventListener('click', ()=>{
      timeToggleTop.classList.toggle('active');
      topTimeVisible = timeToggleTop.classList.contains('active');
      headerTimestamp.style.display = topTimeVisible ? '' : 'none';
      asideTimestamp.style.display = topTimeVisible ? '' : 'none';
      if(topTimeVisible) updateTimestamp();
    });
    const themeToggle = document.getElementById('themeToggle');
    themeToggle.addEventListener('click', ()=>{
      themeToggle.classList.toggle('active');
      document.documentElement.classList.toggle('dark');
    });

    function updateActivePriceDisplay(){
      const active = document.querySelector('.tab.active').dataset.mode;
      let pricePerGram = NaN, purity = 18;
      if(active==='parsian'){
        purity = (parsianPurity.value==='custom'? Number(parsianPurityCustom.value): Number(parsianPurity.value)) || 18;
        const p18 = unfmt(price18Input.value);
        if(!isNaN(p18)) pricePerGram = p18*(purity/18);
        else { const p24 = unfmt(price24Input.value); if(!isNaN(p24)) pricePerGram = p24*(purity/24); }
      } else if(active==='shamsh'){
        purity = (shamshPurity.value==='custom'? Number(shamshPurityCustom.value): Number(shamshPurity.value)) || 24;
        const p24 = unfmt(price24Input.value);
        if(!isNaN(p24)) pricePerGram = p24*(purity/24);
        else { const p18 = unfmt(price18Input.value); if(!isNaN(p18)) pricePerGram = p18*(purity/18); }
      } else {
        purity = (fabPurity.value==='custom'? Number(fabPurityCustom.value): Number(fabPurity.value)) || 18;
        const p18 = unfmt(price18Input.value);
        if(!isNaN(p18)) pricePerGram = p18*(purity/18);
        else { const p24 = unfmt(price24Input.value); if(!isNaN(p24)) pricePerGram = p24*(purity/24); }
      }
      document.getElementById('activePriceDisplay').textContent = isNaN(pricePerGram) ? 'قیمت وارد نشده' : (fmt(Math.round(pricePerGram)) + ' تومان (عیار ' + purity + ')');
    }

    function updateTimestamp(){
      const now = (new Date()).toLocaleString();
      if(headerTimestamp) headerTimestamp.textContent = now;
      if(asideTimestamp) asideTimestamp.textContent = now;
    }

    function autoCalcActive() {
      const active = document.querySelector('.tab.active').dataset.mode;
      if(active === 'parsian') {
        const w = parsianCustomWeight.value && String(parsianCustomWeight.value).trim() !== '' ? Number(parsianCustomWeight.value) : null;
        renderParsianTable(w);
      } else if(active === 'shamsh') {
        const w = shamshCustomWeight.value && String(shamshCustomWeight.value).trim() !== '' ? Number(shamshCustomWeight.value) : null;
        renderShamshTable(w);
      } else {
        fabricateCalculate();
      }
      updateActivePriceDisplay();
    }

    parsianCalcBtn.addEventListener('click', ()=>{ const w = parsianCustomWeight.value.trim(); renderParsianTable(w? Number(w) : null); updateTimestamp(); updateActivePriceDisplay(); });
    shamshCalcBtn.addEventListener('click', ()=>{ const w = shamshCustomWeight.value.trim(); renderShamshTable(w? Number(w) : null); updateTimestamp(); updateActivePriceDisplay(); });
    document.getElementById('fabCalc').addEventListener('click', ()=>{ fabricateCalculate(); updateActivePriceDisplay(); });

    document.addEventListener('click', function(e){
      const btn = e.target.closest('.clear-btn');
      if(!btn) return;
      const targetId = btn.getAttribute('data-target');
      if(targetId) {
        const el = document.getElementById(targetId);
        if(el){ el.value = ''; el.dispatchEvent(new Event('input')); autoCalcActive(); }
      }
    });

    document.querySelectorAll('.tiny-toggle').forEach(t=>{
      t.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); t.click(); } });
    });

    document.body.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){
        const active = document.querySelector('.tab.active').dataset.mode;
        if(active==='parsian') parsianCalcBtn.click();
        else if(active==='shamsh') shamshCalcBtn.click();
        else document.getElementById('fabCalc').click();
      }
    });

    // initial UI
    updateActivePriceDisplay();
    asideTimestamp.style.display = 'none';

    /* ================== Fetch price logic (single initial fetch + manual refresh) ==================
       - update3(shouldSetInput)
         - shouldSetInput = true : set both display and price18 input (used on initial load and when user presses fetch button)
         - shouldSetInput = false: update only display (not used here, kept for completeness)
       - No periodic automatic polling.
    =================================================================== */
    var geram18_prev = 10444;
    var geram18_now;
    function update3(shouldSetInput){
      var item = "c";
      geram18_prev = parseFloat(geram18_prev);
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.onreadystatechange = function() {
        if (xmlHttp.readyState == 4 && (xmlHttp.status == 200 || xmlHttp.status == 304)) {
          try {
            var html = JSON.parse(xmlHttp.responseText);
            if (geram18_now != null) { geram18_prev = geram18_now; }
            geram18_now = parseFloat(html["c"]);
            var priceElement = document.getElementById("gram18_price_now");
            if (priceElement) {
              var raw = parseInt(geram18_now, 10);
              if (!isFinite(raw)) raw = 0;
              var normalized = raw;
              if (Math.abs(normalized) < 100000) normalized = normalized * 1000; // normalize shorthand numbers like 10500 -> 10,500,000
              priceElement.innerHTML = normalized.toLocaleString("en-US") + " تومان";
              if (shouldSetInput && price18Input) {
                price18Input.value = normalized ? fmt(Math.round(normalized)) : '';
                // sync and calculate after setting input
                syncFrom18();
                autoCalcActive();
              }
            }
          } catch (e) {
            console.log("Error updating price:", e);
          }
        }
      };
      xmlHttp.open("GET", "https://tabangohar.com/GheymatKhan/prices_in_table.html?v=" + (new Date().toISOString().substring(0,16)), true);
      xmlHttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      xmlHttp.send("item=" + item);
    }

    // initial fetch once on load and set inputs
    try { update3(true); } catch(e){ console.log('update3 initial error', e); }

    // fetch button: user-initiated refresh — will overwrite price18 input & display
    fetchBtn.addEventListener('click', function(){ update3(true); });

    /* attach generic autocalc listeners */
    document.querySelectorAll('.wrap input, .wrap select').forEach(el=>{
      if(!el.dataset._autocalc){
        el.addEventListener('input', autoCalcActive);
        el.addEventListener('change', autoCalcActive);
        el.dataset._autocalc = '1';
      }
    });

    document.querySelectorAll('.clear-btn').forEach(b=>{
      b.setAttribute('tabindex','0');
      b.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); b.click(); } });
    });
  </script>
</body>
</html>
